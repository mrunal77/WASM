@page "/calculator"
@using System.Globalization
@* @rendermode "ServerPrerendered" *@
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="calculator-container" @ref="calculatorRef" tabindex="0" aria-label="Calculator" role="region" @onkeydown="HandleKeyDown">
    <div class="calculator-header"
         @onmousedown="StartDrag"
         @ontouchstart="StartDrag">
        <span class="calculator-title">Calculator</span>
        @* <button class="close-btn" @onclick="CloseCalculator" aria-label="Close Calculator">&times;</button> *@
    </div>
    <div class="calculator-display" role="status" aria-live="polite">@DisplayValue</div>
    <div class="calculator-buttons" role="group" aria-label="Calculator buttons">
        @foreach (var row in ButtonRows)
        {
            <div class="calculator-row">
                @foreach (var button in row)
                {
                    <button class="calculator-btn"
                            @onclick="() => OnButtonClick(button.Label)"
                            aria-label="@button.AriaLabel"
                            disabled="@button.Disabled"
                            tabindex="0">
                        @button.Label
                    </button>
                }
            </div>
        }
    </div>
</div>

@code {
    private ElementReference calculatorRef;
    private IJSObjectReference dragModule;
    private DotNetObjectReference<Calculator> dotNetRef;
    private bool isDragging = false;
    private double startX, startY;
    private double initialLeft = 45, initialTop = 20;
    private string input = "";
    private string lastOperator = "";
    private decimal? accumulator = null;
    private bool isNewEntry = true;
    private string errorMessage = null;

    private string DisplayValue => errorMessage ?? (input == "" ? (accumulator?.ToString("G", CultureInfo.InvariantCulture) ?? "0") : input);

    private class CalculatorButton
    {
        public string Label { get; set; }
        public string AriaLabel { get; set; }
        public bool Disabled { get; set; }
    }

    private List<List<CalculatorButton>> ButtonRows = new()
    {
        new() { new() { Label = "7", AriaLabel = "Seven" }, new() { Label = "8", AriaLabel = "Eight" }, new() { Label = "9", AriaLabel = "Nine" }, new() { Label = "/", AriaLabel = "Divide" } },
        new() { new() { Label = "4", AriaLabel = "Four" }, new() { Label = "5", AriaLabel = "Five" }, new() { Label = "6", AriaLabel = "Six" }, new() { Label = "*", AriaLabel = "Multiply" } },
        new() { new() { Label = "1", AriaLabel = "One" }, new() { Label = "2", AriaLabel = "Two" }, new() { Label = "3", AriaLabel = "Three" }, new() { Label = "-", AriaLabel = "Subtract" } },
        new() { new() { Label = "0", AriaLabel = "Zero" }, new() { Label = ".", AriaLabel = "Decimal point" }, new() { Label = "=", AriaLabel = "Equals" }, new() { Label = "+", AriaLabel = "Add" } },
        new() { new() { Label = "C", AriaLabel = "Clear" }, new() { Label = "⌫", AriaLabel = "Backspace" } }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            dragModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/CalculatorDrag.cs.js");
            await dragModule.InvokeVoidAsync("enableCSDrag", calculatorRef, dotNetRef);
            await calculatorRef.FocusAsync();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (dragModule != null)
        {
            try
            {
                await dragModule.InvokeVoidAsync("disableCSDrag");
                await dragModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Ignore if circuit is disconnected (Blazor Server)
            }
        }
        dotNetRef?.Dispose();
    }

    private async Task StartDrag(MouseEventArgs e)
    {
        isDragging = true;
        startX = e.ClientX;
        startY = e.ClientY;
        
        // Get current position from CSS using JavaScript
        var rect = await dragModule.InvokeAsync<ClientRect>("getElementRect", calculatorRef);
        initialLeft = rect.Left;
        initialTop = rect.Top;
        
        await dragModule.InvokeVoidAsync("setDragging", true);
    }

    private async Task StartDrag(TouchEventArgs e)
    {
        if (e.Touches.Length != 1) return;
        
        isDragging = true;
        startX = e.Touches[0].ClientX;
        startY = e.Touches[0].ClientY;
        
        var rect = await dragModule.InvokeAsync<ClientRect>("getElementRect", calculatorRef);
        initialLeft = rect.Left;
        initialTop = rect.Top;
        
        await dragModule.InvokeVoidAsync("setDragging", true);
    }

    [JSInvokable]
    public async Task HandleMouseMove(double clientX, double clientY)
    {
        if (!isDragging) return;
        
        var dx = clientX - startX;
        var dy = clientY - startY;
        
        var newLeft = initialLeft + dx;
        var newTop = initialTop + dy;
        
        await UpdateCalculatorPosition(newLeft, newTop);
    }

    [JSInvokable]
    public async Task HandleTouchMove(double clientX, double clientY)
    {
        if (!isDragging) return;
        
        var dx = clientX - startX;
        var dy = clientY - startY;
        
        var newLeft = initialLeft + dx;
        var newTop = initialTop + dy;
        
        await UpdateCalculatorPosition(newLeft, newTop);
    }

    private async Task UpdateCalculatorPosition(double left, double top)
    {
        await dragModule.InvokeVoidAsync("updateCalculatorPosition", calculatorRef, left, top);
    }

    [JSInvokable]
    public void StopDrag()
    {
        isDragging = false;
    }

    private class ClientRect
    {
        public double Left { get; set; }
        public double Top { get; set; }
        public double Width { get; set; }
        public double Height { get; set; }
    }

    private void OnButtonClick(string label)
    {
        if (errorMessage != null)
        {
            errorMessage = null;
            input = "";
            lastOperator = "";
            accumulator = null;
            isNewEntry = true;
        }

        if (char.IsDigit(label, 0) || label == ".")
        {
            if (isNewEntry)
            {
                input = "";
                isNewEntry = false;
            }
            if (label == "." && input.Contains(".")) return;
            input += label;
        }
        else if ("+-*/".Contains(label))
        {
            CommitInput();
            lastOperator = label;
            isNewEntry = true;
        }
        else if (label == "=")
        {
            CommitInput();
            lastOperator = "";
            isNewEntry = true;
        }
        else if (label == "C")
        {
            input = "";
            lastOperator = "";
            accumulator = null;
            errorMessage = null;
            isNewEntry = true;
        }
        else if (label == "⌫")
        {
            if (!isNewEntry && input.Length > 0)
                input = input.Substring(0, input.Length - 1);
        }
    }

    private void CommitInput()
    {
        if (!decimal.TryParse(input, System.Globalization.NumberStyles.Number, CultureInfo.InvariantCulture, out var value))
        {
            errorMessage = "Invalid input";
            return;
        }
        if (accumulator == null)
        {
            accumulator = value;
        }
        else if (!string.IsNullOrEmpty(lastOperator))
        {
            try
            {
                accumulator = lastOperator switch
                {
                    "+" => accumulator + value,
                    "-" => accumulator - value,
                    "*" => accumulator * value,
                    "/" => value == 0 ? throw new DivideByZeroException() : accumulator / value,
                    _ => accumulator
                };
            }
            catch (DivideByZeroException)
            {
                errorMessage = "Cannot divide by zero";
                accumulator = null;
            }
        }
        input = "";
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key.Length == 1 && char.IsDigit(e.Key[0]))
            OnButtonClick(e.Key);
        else if (e.Key == "Enter" || e.Key == "=")
            OnButtonClick("=");
        else if (e.Key == "Backspace")
            OnButtonClick("⌫");
        else if (e.Key == "Escape")
            OnButtonClick("C");
        else if ("+-*/.".Contains(e.Key))
            OnButtonClick(e.Key);
    }

    private void CloseCalculator()
    {
        // Optionally hide or remove the calculator from the UI
        // For demo, just clear state
        input = "";
        lastOperator = "";
        accumulator = null;
        errorMessage = null;
        isNewEntry = true;
    }
}